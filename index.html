<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Fukumado Twitch Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #root {
      width: 100%;
      height: 100%;
    }

    /* サイドバイサイド */
    .layout-side {
      display: flex;
      flex-direction: row;
      width: 100%;
      height: 100%;
    }

    .layout-side.reverse {
      flex-direction: row-reverse;
    }

    #video-area {
      flex: 1 1 auto;
      position: relative;
      background: #000;
    }

    #chat-area {
      flex: 0 0 30%;
      max-width: 360px;
      min-width: 220px;
      height: 100%;
      background: #18181b;
    }

    /* オーバーレイ */
    .layout-overlay {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .layout-overlay #video-area {
      position: absolute;
      inset: 0;
    }

    .layout-overlay #chat-area {
      position: absolute;
      width: 40%;
      max-width: 380px;
      height: 45%;
      max-height: 320px;
      pointer-events: auto;
      background: #18181b;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.7);
    }

    .pos-top-left    { top: 0.5rem; left: 0.5rem; }
    .pos-top-right   { top: 0.5rem; right: 0.5rem; }
    .pos-bottom-left { bottom: 0.5rem; left: 0.5rem; }
    .pos-bottom-right{ bottom: 0.5rem; right: 0.5rem; }

    .chat-hidden #chat-area {
      display: none;
    }

    #player-container,
    #chat-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>

  <!-- Twitch プレイヤー JS -->
  <script src="https://player.twitch.tv/js/embed/v1.js"></script>
</head>
<body>
  <div id="root" class="layout-side">
    <div id="video-area">
      <div id="player-container"></div>
    </div>
    <div id="chat-area">
      <iframe id="chat-iframe" loading="lazy"></iframe>
    </div>
  </div>

  <script>
    // ===== クエリ取得 =====
    const qs = new URLSearchParams(window.location.search);

    const channelParam     = qs.get('channel');      // 生放送用
    const videoParam       = qs.get('video');        // VOD用 (例: v40464143)
    const chatChannelParam = qs.get('chatChannel');  // チャット表示に使うチャンネル名（任意）

    const mutedParam       = qs.get('muted');
    const volumeParam      = qs.get('volume');       // 今回は初期音量固定なので実質未使用
    const chatParam        = qs.get('chat');         // 'on' / 'off'
    const modeParam        = qs.get('mode');         // 'side' / 'overlay'
    const sideParam        = qs.get('side');         // 'left' / 'right'
    const overlayPosParam  = qs.get('pos');          // 'tl' / 'tr' / 'bl' / 'br'

    const initialMuted  = mutedParam === '1';
    // 初期音量は常に一定値にする（muted フラグだけで ON/OFF を制御）
    const initialVolume = 1.0;

    // チャットに使うチャンネル名
    const chatChannel =
      chatChannelParam ||
      channelParam ||
      null;

    // ===== レイアウトDOM =====
    const rootEl = document.getElementById('root');
    const chatIframe = document.getElementById('chat-iframe');

    function setChatVisible(isVisible) {
      rootEl.classList.toggle('chat-hidden', !isVisible);
    }

    function setChatMode(mode) {
      rootEl.classList.remove('layout-side', 'layout-overlay');
      if (mode === 'overlay') {
        rootEl.classList.add('layout-overlay');
      } else {
        rootEl.classList.add('layout-side');
      }
    }

    function setSidePosition(side) {
      const reverse = side === 'left';
      rootEl.classList.toggle('reverse', reverse);
    }

    function setOverlayPosition(pos) {
      const chatArea = document.getElementById('chat-area');
      chatArea.classList.remove(
        'pos-top-left',
        'pos-top-right',
        'pos-bottom-left',
        'pos-bottom-right'
      );
      switch (pos) {
        case 'tl': chatArea.classList.add('pos-top-left'); break;
        case 'tr': chatArea.classList.add('pos-top-right'); break;
        case 'bl': chatArea.classList.add('pos-bottom-left'); break;
        case 'br':
        default:   chatArea.classList.add('pos-bottom-right'); break;
      }
    }

    // ===== 初期レイアウト（URL から反映） =====
    (function initLayoutFromParams() {
      const chatOn = (chatParam !== 'off') && !!chatChannel;
      setChatVisible(chatOn);

      const mode = (modeParam === 'overlay') ? 'overlay' : 'side';
      setChatMode(mode);

      if (mode === 'side') {
        const side = (sideParam === 'left') ? 'left' : 'right';
        setSidePosition(side);
      } else {
        const pos = overlayPosParam || 'br';
        setOverlayPosition(pos);
      }
    })();

    // ===== Twitch プレイヤー初期化 =====
    const TWITCH_PARENT = 'kentsjp.github.io';

    const playerOptions = {
      width: '100%',
      height: '100%',
      parent: [TWITCH_PARENT],
      autoplay: true,
      muted: initialMuted  // ← initialMuted を使用
    };

    if (videoParam) {
      playerOptions.video = videoParam;
    } else if (channelParam) {
      playerOptions.channel = channelParam;
    } else {
      playerOptions.channel = 'twitch';
    }

    const player = new Twitch.Player('player-container', playerOptions);

    // 初回再生のリトライ用
    let initialPlayAttempts = 0;
    const MAX_INITIAL_PLAY_ATTEMPTS = 3;

    function tryInitialPlay() {
      if (initialPlayAttempts >= MAX_INITIAL_PLAY_ATTEMPTS) return;
      initialPlayAttempts++;
      try {
        if (typeof player.play === 'function') {
          player.play();
        }
      } catch (e) {
        // ここでは握りつぶすだけ
      }
    }

    player.addEventListener(Twitch.Player.READY, function () {
      // 初期音量
      if (!isNaN(initialVolume)) {
        try { player.setVolume(initialVolume); } catch (e) {}
      }

      // Flutter 側から渡された初期ミュート（音あり窓＝false / 音なし窓＝true）
      try { player.setMuted(initialMuted); } catch (e) {}

      // ★ 音あり／音なしに関係なく、全窓で「再生」だけは最大3回試す
      tryInitialPlay();
      setTimeout(tryInitialPlay, 300);
      setTimeout(tryInitialPlay, 1000);
    });

    // ===== チャット iframe 初期化 =====
    function buildChatUrl(channelName) {
      const base = 'https://www.twitch.tv/embed/' + encodeURIComponent(channelName) + '/chat';
      const url = new URL(base);
      url.searchParams.set('parent', TWITCH_PARENT);
      url.searchParams.set('darkpopout', '');
      return url.toString();
    }

    if (chatChannel) {
      chatIframe.src = buildChatUrl(chatChannel);
    } else {
      setChatVisible(false);
    }

    // ===== Fukumado からの JS ブリッジ =====

    window.fukumadoSetChatVisible = function (isVisible) {
      if (!chatChannel) return;
      setChatVisible(!!isVisible);
    };

    window.fukumadoSetChatMode = function (mode) {
      setChatMode(mode === 'overlay' ? 'overlay' : 'side');
    };

    window.fukumadoSetChatSide = function (side) {
      setSidePosition(side === 'left' ? 'left' : 'right');
    };

    window.fukumadoSetChatOverlayPos = function (pos) {
      setOverlayPosition(pos || 'br');
    };

    // グローバル音声切り替え用の再生状態トラッキング
    let shouldBePlaying = false;
    let retryCount = 0;
    const MAX_RETRY = 2;

    // muted: true/false, byGlobal: グローバル音声切り替え由来かどうか
    window.fukumadoSetMuted = function (muted, byGlobal) {
      if (!player) return;

      const m = !!muted;
      const global = !!byGlobal;

      try {
        player.setMuted(m);
      } catch (e) {}

      if (global && !m) {
        // この窓は「音ありで再生していたい」
        shouldBePlaying = true;
        retryCount = 0;
        tryPlayWithRetry();
      } else if (m) {
        // ミュート指定 → 音が鳴っている必要はない
        shouldBePlaying = false;
      }
    };

    function tryPlayWithRetry() {
      if (!shouldBePlaying || retryCount >= MAX_RETRY) return;
      retryCount++;
      try {
        if (typeof player.play === 'function') {
          player.play();
        }
      } catch (e) {
        // ここでは握りつぶすだけ
      }
    }

    // PAUSE されたら、必要ならもう一度だけ play を試す
    player.addEventListener(Twitch.Player.PAUSE, function () {
      if (!shouldBePlaying) return;
      setTimeout(tryPlayWithRetry, 200);
    });

    // 自動再生ブロック系イベントが来たら諦める
    player.addEventListener(Twitch.Player.PLAYBACK_BLOCKED, function () {
      shouldBePlaying = false;
    });

    window.fukumadoSetVolume = function (volume) {
      const v = Math.max(0, Math.min(1, Number(volume)));
      try {
        player.setVolume(v);
      } catch (e) {}
      if (v > 0) {
        try {
          player.setMuted(false);
        } catch (e) {}
      }
    };

  </script>
</body>
</html>
